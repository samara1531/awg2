name: X-Multi-Target Build AmneziaWG

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: "OpenWrt version (например: 23.05.5 или SNAPSHOT)"
        required: true
        default: "23.05.5"
      amneziawg_version:
        description: "AmneziaWG версия (main или тег)"
        required: true
        default: "main"
      compile_kmod:
        description: "Компилировать kernel module"
        type: boolean
        default: true
      compile_go:
        description: "Компилировать Go реализацию"
        type: boolean
        default: true

jobs:
  generate-matrix:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: 'npm'

      - name: Install dependencies
        run: npm install axios cheerio

      - name: Generate build matrix
        id: set-matrix
        run: |
          node generate-matrix.js ${{ inputs.openwrt_version }} > matrix.json
          echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT

  build-awg:
    needs: generate-matrix
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    env:
      COMPILE_KMOD: ${{ inputs.compile_kmod }}
      COMPILE_GO: ${{ inputs.compile_go }}
      AWG_VERSION: ${{ inputs.amneziawg_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: amneziawg
          ref: ${{ inputs.amneziawg_version }}

      - name: Checkout OpenWrt Packages (golang)
        uses: actions/checkout@v4
        with:
          repository: openwrt/packages
          path: packages
          ref: openwrt-23.05  # или master для SNAPSHOT

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-pyelftools python3-dev python3-setuptools swig curl zip unzip zstd

      - name: Download and prepare SDK
        run: |
          set -euo pipefail
          VERSION="${{ inputs.openwrt_version }}"
          TARGET="${{ matrix.target }}"
          SUBTARGET="${{ matrix.subtarget }}"
          PKGARCH="${{ matrix.pkgarch }}"

          if [[ "$VERSION" == "SNAPSHOT" ]]; then
            BASE_URL="https://downloads.openwrt.org/snapshots/targets/$TARGET/$SUBTARGET"
          else
            MIRRORS=(
              "https://downloads.openwrt.org/releases/$VERSION/targets/$TARGET/$SUBTARGET"
              "https://mirror-01.infra.openwrt.org/releases/$VERSION/targets/$TARGET/$SUBTARGET"
              "https://mirror-02.infra.openwrt.org/releases/$VERSION/targets/$TARGET/$SUBTARGET"
              "https://mirror-03.infra.openwrt.org/releases/$VERSION/targets/$TARGET/$SUBTARGET"
            )
            BASE_URL=""
            for url in "${MIRRORS[@]}"; do
              if curl -fs --head "$url/" | head -n 1 | grep -q "200"; then
                BASE_URL="$url"
                break
              fi
            done
            [[ -n "$BASE_URL" ]] || { echo "No mirror available"; exit 1; }
          fi

          SDK_FILE=$(curl -fsSL "$BASE_URL/" | grep -oP 'openwrt-sdk[^"]+\.(tar\.xz|tar\.zst)' | head -1)
          [[ -n "$SDK_FILE" ]] || { echo "SDK not found"; exit 1; }

          echo "Downloading SDK: $BASE_URL/$SDK_FILE"
          curl -fL --progress-bar "$BASE_URL/$SDK_FILE" -o sdk.archive
          case "$SDK_FILE" in
            *.tar.xz)  tar -xJf sdk.archive ;;
            *.tar.zst) zstd -d --force sdk.archive --stdout | tar -xf - ;;
          esac

          mv openwrt-sdk* openwrt
          rm -f sdk.archive

          # Добавляем наш пакет
          echo "src-link awg ../amneziawg" >> openwrt/feeds.conf.default
          ./openwrt/scripts/feeds update -a

          # Конфиг
          curl -fsL "$BASE_URL/config.buildinfo" -o openwrt/.config || true
          cat >> openwrt/.config <<EOF
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20=y
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=y
          CONFIG_PACKAGE_kmod-crypto-chacha20poly1305=y
          CONFIG_PACKAGE_kmod-amneziawg=y
          CONFIG_PACKAGE_amneziawg-go=y
          CONFIG_PACKAGE_amneziawg-tools=y
          CONFIG_PACKAGE_luci-proto-amneziawg=y
          EOF

          # Обновляем golang из packages, если нужно
          if [[ "$COMPILE_GO" == "true" ]]; then
            rm -rf openwrt/feeds/packages/lang/golang
            cp -r packages/lang/golang openwrt/feeds/packages/lang/
            ./openwrt/scripts/feeds update -a
          fi

          ./openwrt/scripts/feeds install -a
          make -C openwrt defconfig

      - name: Compile AmneziaWG packages
        run: |
          cd openwrt
          MAKE="make -j$(nproc) V=s"

          if [[ "$COMPILE_KMOD" == "true" ]]; then
            $MAKE package/kmod-amneziawg/compile || echo "kmod failed"
          fi
          if [[ "$COMPILE_GO" == "true" ]]; then
            $MAKE package/amneziawg-go/compile || echo "go failed"
          fi
          $MAKE package/amneziawg-tools/compile || true
          $MAKE package/luci-proto-amneziawg/compile || true

      - name: Upload artifacts to Release
        run: |
          mkdir -p release
          find openwrt/bin -name "*amneziawg*" -type f -exec cp {} release/ \; || true

          if [ -z "$(ls release)" ]; then
            echo "No packages built"
            exit 0
          fi

          ZIP="AWG-${{ inputs.openwrt_version }}-${{ matrix.target }}-${{ matrix.subtarget }}-${{ matrix.pkgarch }}.zip"
          zip -j "$ZIP" release/*

          gh release create "${{ inputs.openwrt_version }}" \
            --title "AmneziaWG for OpenWrt ${{ inputs.openwrt_version }}" \
            --notes "Auto-built packages for ${{ matrix.target }}/${{ matrix.subtarget }}" \
            --draft=false --prerelease=false || echo "Release exists"

          gh release upload "${{ inputs.openwrt_version }}" "$ZIP" --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
